{% extends "mobile_base.html" %}
{% block title %}Scan Equipment{% endblock %}
{% block header_title %}Scan QR/Barcode{% endblock %}

{% block header_left %}
<a href="{{ url_for('mobile.worker_dashboard') }}" class="p-2 touch-btn">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
    </svg>
</a>
{% endblock %}

{% block content %}
<div class="p-4 space-y-4">
    <!-- Scanner Viewport -->
    <div class="bg-black rounded-xl overflow-hidden relative" style="height: 300px;">
        <video id="scanner-video" class="w-full h-full object-cover"></video>
        <!-- Scanner overlay -->
        <div class="absolute inset-0 flex items-center justify-center">
            <div class="w-48 h-48 border-2 border-white rounded-lg relative">
                <div class="absolute top-0 left-0 w-6 h-6 border-l-4 border-t-4 border-blue-400"></div>
                <div class="absolute top-0 right-0 w-6 h-6 border-r-4 border-t-4 border-blue-400"></div>
                <div class="absolute bottom-0 left-0 w-6 h-6 border-l-4 border-b-4 border-blue-400"></div>
                <div class="absolute bottom-0 right-0 w-6 h-6 border-r-4 border-b-4 border-blue-400"></div>
                <!-- Scanning line animation -->
                <div class="absolute left-0 right-0 h-0.5 bg-blue-400 animate-pulse" style="top: 50%;"></div>
            </div>
        </div>
        <!-- Status message -->
        <div class="absolute bottom-4 left-0 right-0 text-center">
            <span id="scan-status" class="bg-black/50 text-white px-4 py-2 rounded-full text-sm">
                Point camera at QR code or barcode
            </span>
        </div>
    </div>

    <!-- Manual Entry -->
    <div class="bg-white rounded-xl shadow-sm p-4">
        <h3 class="font-semibold mb-3">Or Enter Manually</h3>
        <div class="flex gap-3">
            <input type="text" id="manual-code" class="flex-1 border border-gray-300 rounded-lg p-3 text-base"
                   placeholder="Enter equipment ID...">
            <button onclick="manualLookup()" class="px-4 bg-blue-600 text-white rounded-lg font-medium">
                Search
            </button>
        </div>
    </div>

    <!-- Recent Scans -->
    <div class="bg-white rounded-xl shadow-sm">
        <div class="p-4 border-b">
            <h3 class="font-semibold">Recent Scans</h3>
        </div>
        <div class="divide-y" id="recent-scans">
            <div class="p-4 flex items-center gap-3" onclick="loadEquipment('EQ-001')">
                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="font-medium">EQ-001</p>
                    <p class="text-sm text-gray-500">CAT 320 Excavator</p>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
            <div class="p-4 flex items-center gap-3" onclick="loadEquipment('EQ-015')">
                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <p class="font-medium">EQ-015</p>
                    <p class="text-sm text-gray-500">Komatsu D61 Bulldozer</p>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
        </div>
    </div>

    <!-- Scan Result Modal (hidden by default) -->
    <div id="scan-result" class="hidden fixed inset-0 bg-black/50 z-50 flex items-end">
        <div class="bg-white w-full rounded-t-2xl p-6 animate-slide-up">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <div id="result-content"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block nav %}
<nav class="mobile-nav bg-white border-t flex justify-around py-2">
    <a href="{{ url_for('mobile.worker_dashboard') }}" class="flex flex-col items-center p-2 text-gray-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
        </svg>
        <span class="text-xs mt-1">Home</span>
    </a>
    <a href="{{ url_for('mobile.worker_jobs') }}" class="flex flex-col items-center p-2 text-gray-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        <span class="text-xs mt-1">Jobs</span>
    </a>
    <a href="{{ url_for('mobile.worker_history') }}" class="flex flex-col items-center p-2 text-gray-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span class="text-xs mt-1">History</span>
    </a>
    <a href="{{ url_for('mobile.worker_profile') }}" class="flex flex-col items-center p-2 text-gray-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
        <span class="text-xs mt-1">Profile</span>
    </a>
</nav>
{% endblock %}

{% block scripts %}
<style>
@keyframes slide-up {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}
.animate-slide-up { animation: slide-up 0.3s ease-out; }
</style>
<script>
let scanner = null;

// Initialize camera
async function initScanner() {
    const video = document.getElementById('scanner-video');

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
        });
        video.srcObject = stream;
        video.play();

        document.getElementById('scan-status').textContent = 'Scanning...';
    } catch (err) {
        document.getElementById('scan-status').textContent = 'Camera not available';
        console.error('Camera error:', err);
    }
}

function manualLookup() {
    const code = document.getElementById('manual-code').value.trim();
    if (code) {
        lookupEquipment(code);
    }
}

function loadEquipment(code) {
    lookupEquipment(code);
}

async function lookupEquipment(code) {
    document.getElementById('scan-status').textContent = 'Looking up...';

    try {
        const response = await fetch('/mobile/worker/scan/result', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({code: code})
        });
        const data = await response.json();

        if (data.success && data.equipment) {
            showResult(data.equipment);
            hapticFeedback('medium');
        } else {
            showToast('Equipment not found');
            document.getElementById('scan-status').textContent = 'Not found - try again';
        }
    } catch (err) {
        showToast('Error looking up equipment');
    }
}

function showResult(equipment) {
    const content = `
        <div class="text-center mb-4">
            <div class="w-16 h-16 bg-green-100 rounded-full mx-auto flex items-center justify-center mb-3">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h3 class="text-xl font-semibold">${equipment.unique_id}</h3>
            <p class="text-gray-500">${equipment.brand || ''} ${equipment.model || ''}</p>
        </div>
        <div class="space-y-3">
            <a href="/mobile/worker/job/new?equipment_id=${equipment.id}" class="block w-full py-3 bg-blue-600 text-white text-center rounded-lg font-medium">
                Start New Job
            </a>
            <a href="/mobile/worker/inspection/perform/${equipment.id}" class="block w-full py-3 border border-blue-600 text-blue-600 text-center rounded-lg font-medium">
                Start Inspection
            </a>
            <a href="/mobile/worker/report?equipment_id=${equipment.id}" class="block w-full py-3 border border-gray-300 text-gray-600 text-center rounded-lg font-medium">
                Report Issue
            </a>
            <button onclick="hideResult()" class="w-full py-3 text-gray-500 font-medium">Cancel</button>
        </div>
    `;

    document.getElementById('result-content').innerHTML = content;
    document.getElementById('scan-result').classList.remove('hidden');
}

function hideResult() {
    document.getElementById('scan-result').classList.add('hidden');
}

// Initialize on load
document.addEventListener('DOMContentLoaded', initScanner);
</script>
{% endblock %}
