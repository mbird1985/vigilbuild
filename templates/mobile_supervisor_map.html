{% extends "mobile_base.html" %}
{% block title %}Map View{% endblock %}
{% block header_title %}Map{% endblock %}

{% block header_left %}
<a href="{{ url_for('mobile.supervisor_dashboard') }}" class="p-2 touch-btn">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
    </svg>
</a>
{% endblock %}

{% block header_right %}
<button onclick="toggleLayers()" class="p-2 touch-btn">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
    </svg>
</button>
{% endblock %}

{% block content %}
<!-- Full height map -->
<div id="map" class="w-full" style="height: calc(100vh - 120px);"></div>

<!-- Floating Legend -->
<div id="legend" class="absolute bottom-20 left-4 bg-white rounded-xl shadow-lg p-3 text-sm">
    <div class="flex items-center gap-2 mb-2">
        <span class="w-3 h-3 bg-green-500 rounded-full"></span>
        <span>Active Crew</span>
    </div>
    <div class="flex items-center gap-2 mb-2">
        <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
        <span>Jobs In Progress</span>
    </div>
    <div class="flex items-center gap-2">
        <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
        <span>Assigned Jobs</span>
    </div>
</div>

<!-- Floating Actions -->
<div class="absolute bottom-20 right-4 space-y-2">
    <button onclick="centerOnLocation()" class="bg-white rounded-full shadow-lg p-3">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
    </button>
    <button onclick="refreshLocations()" class="bg-white rounded-full shadow-lg p-3">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
    </button>
</div>

<!-- Layers Panel (hidden by default) -->
<div id="layers-panel" class="hidden absolute top-0 right-0 left-0 bg-white shadow-lg p-4 z-10">
    <h3 class="font-semibold mb-3">Map Layers</h3>
    <div class="space-y-2">
        <label class="flex items-center">
            <input type="checkbox" id="layer-crew" checked class="mr-3 w-5 h-5">
            <span>Crew Locations</span>
        </label>
        <label class="flex items-center">
            <input type="checkbox" id="layer-jobs" checked class="mr-3 w-5 h-5">
            <span>Active Jobs</span>
        </label>
        <label class="flex items-center">
            <input type="checkbox" id="layer-equipment" class="mr-3 w-5 h-5">
            <span>Equipment</span>
        </label>
        <label class="flex items-center">
            <input type="checkbox" id="layer-outages" checked class="mr-3 w-5 h-5">
            <span>Outages/Alerts</span>
        </label>
    </div>
    <button onclick="toggleLayers()" class="mt-4 w-full py-2 bg-gray-100 rounded-lg font-medium">Close</button>
</div>
{% endblock %}

{% block nav %}
<nav class="mobile-nav bg-white border-t flex justify-around py-2">
    <a href="{{ url_for('mobile.supervisor_dashboard') }}" class="flex flex-col items-center p-2 text-gray-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
        </svg>
        <span class="text-xs mt-1">Dashboard</span>
    </a>
    <a href="{{ url_for('mobile.supervisor_crew') }}" class="flex flex-col items-center p-2 text-gray-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        <span class="text-xs mt-1">Crew</span>
    </a>
    <a href="{{ url_for('mobile.supervisor_all_jobs') }}" class="flex flex-col items-center p-2 text-gray-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        <span class="text-xs mt-1">Jobs</span>
    </a>
    <a href="{{ url_for('mobile.supervisor_map') }}" class="flex flex-col items-center p-2 text-blue-600">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>
        </svg>
        <span class="text-xs mt-1">Map</span>
    </a>
</nav>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
.crew-marker {
    background: #22c55e;
    border: 3px solid white;
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
.job-marker-progress {
    background: #eab308;
    border: 2px solid white;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
.job-marker-assigned {
    background: #3b82f6;
    border: 2px solid white;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
</style>
<script>
let map;
let crewMarkers = [];
let jobMarkers = [];

// Initialize map
document.addEventListener('DOMContentLoaded', function() {
    map = L.map('map').setView([40.7128, -74.0060], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Add sample markers
    addSampleData();

    // Start location updates
    setInterval(refreshLocations, 30000);
});

function addSampleData() {
    // Sample crew locations
    const crewData = [
        {lat: 40.7128, lng: -74.0060, name: 'John Smith', status: 'active', job: 'Pole replacement'},
        {lat: 40.7200, lng: -74.0100, name: 'Mike Johnson', status: 'active', job: 'Line inspection'},
        {lat: 40.7050, lng: -73.9950, name: 'Sarah Williams', status: 'break', job: 'Transformer repair'}
    ];

    crewData.forEach(crew => {
        const icon = L.divIcon({
            className: 'crew-marker',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        const marker = L.marker([crew.lat, crew.lng], {icon: icon})
            .bindPopup(`
                <div class="text-center">
                    <strong>${crew.name}</strong><br>
                    <span class="text-sm text-gray-500">${crew.job}</span><br>
                    <span class="text-xs ${crew.status === 'active' ? 'text-green-600' : 'text-yellow-600'}">${crew.status}</span>
                </div>
            `)
            .addTo(map);
        crewMarkers.push(marker);
    });

    // Sample job locations
    const jobData = [
        {lat: 40.7180, lng: -74.0080, status: 'in_progress', equipment: 'POLE-0042', type: 'Repair'},
        {lat: 40.7080, lng: -73.9980, status: 'assigned', equipment: 'XFMR-0015', type: 'Inspection'},
        {lat: 40.7250, lng: -74.0150, status: 'assigned', equipment: 'SW-0089', type: 'Replacement'}
    ];

    jobData.forEach(job => {
        const icon = L.divIcon({
            className: job.status === 'in_progress' ? 'job-marker-progress' : 'job-marker-assigned',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
        });

        const marker = L.marker([job.lat, job.lng], {icon: icon})
            .bindPopup(`
                <div class="text-center">
                    <strong>${job.equipment}</strong><br>
                    <span class="text-sm">${job.type}</span><br>
                    <a href="#" class="text-blue-600 text-sm">View Details</a>
                </div>
            `)
            .addTo(map);
        jobMarkers.push(marker);
    });
}

function centerOnLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            map.setView([pos.coords.latitude, pos.coords.longitude], 14);
            hapticFeedback('light');
        });
    }
}

function refreshLocations() {
    showToast('Locations updated');
    hapticFeedback('light');
    // In real app, fetch new locations from API
}

function toggleLayers() {
    const panel = document.getElementById('layers-panel');
    panel.classList.toggle('hidden');
}

// Layer toggle handlers
document.getElementById('layer-crew')?.addEventListener('change', function() {
    crewMarkers.forEach(m => {
        if (this.checked) map.addLayer(m);
        else map.removeLayer(m);
    });
});

document.getElementById('layer-jobs')?.addEventListener('change', function() {
    jobMarkers.forEach(m => {
        if (this.checked) map.addLayer(m);
        else map.removeLayer(m);
    });
});
</script>
{% endblock %}
