{% extends "base.html" %}
{% block content %}
<div class="space-y-4">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold">{{ board.name }} â€” Calendar</h1>
    <a class="btn-integration btn-blue" href="{{ url_for('pm.board_detail', board_id=board.id, view='kanban') }}">Kanban</a>
  </div>
  <div class="bg-white rounded shadow p-4">
    <div id="calendar"></div>
  </div>
  <div>
    <select id="calendarFilter" onchange="loadEvents()">
      <option value="">All Jobs</option>
      <option value="assigned_to_me">Assigned to Me</option>
      <option value="by_location">By Location</option>
      <option value="near_due">Near Due Date</option>
      <option value="starting_soon">Starting Soon</option>
    </select>
  </div>
  <link rel="stylesheet" href="/static/fullcalendar.min.css">
  <script src="/static/fullcalendar.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        editable: true,
        events: function(fetchInfo, successCallback, failureCallback) {
          // Fetch from unified endpoint, include filter
          const filter = document.getElementById('calendarFilter').value;
          fetch(`/schedule/events?filter=${filter}&board_id={{ board.id }}`)
            .then(response => response.json())
            .then(data => successCallback(data));
        },
        eventClick: function(info) {
          // Show detail modal or redirect to detail
          alert('Event: ' + info.event.title);
          // Or open edit modal
        },
        dateClick: function(info) {
          // Add new event modal
        },
        eventDrop: function(info) {
          // Update dates via API
          fetch(`/pm/items/${info.event.id}`, {
            method: 'PUT',
            body: JSON.stringify({start_date: info.event.start, end_date: info.event.end})
          });
        }
      });
      calendar.render();
    });
  </script>
</div>
{% endblock %}


