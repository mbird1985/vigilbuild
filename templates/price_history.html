{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Price History</h1>
        <a href="{{ url_for('inventory.inventory_list') }}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
            Back to Inventory
        </a>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-sm text-gray-500">Total Price Changes</p>
            <p class="text-2xl font-bold text-gray-800">{{ stats.total_changes or 0 }}</p>
            <p class="text-xs text-gray-400">Last {{ days }} days</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-sm text-gray-500">Price Increases</p>
            <p class="text-2xl font-bold text-red-600">{{ stats.increases or 0 }}</p>
            <p class="text-xs text-gray-400">Avg: +{{ "{:.1f}".format(stats.avg_increase or 0) }}%</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-sm text-gray-500">Price Decreases</p>
            <p class="text-2xl font-bold text-green-600">{{ stats.decreases or 0 }}</p>
            <p class="text-xs text-gray-400">Avg: {{ "{:.1f}".format(stats.avg_decrease or 0) }}%</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-sm text-gray-500">Items Affected</p>
            <p class="text-2xl font-bold text-blue-600">{{ stats.items_affected or 0 }}</p>
            <p class="text-xs text-gray-400">Unique items</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <form method="GET" class="flex flex-wrap gap-4 items-end">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Time Period</label>
                <select name="days" class="border border-gray-300 rounded px-3 py-2">
                    <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 Days</option>
                    <option value="60" {% if days == 60 %}selected{% endif %}>Last 60 Days</option>
                    <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 Days</option>
                    <option value="180" {% if days == 180 %}selected{% endif %}>Last 6 Months</option>
                    <option value="365" {% if days == 365 %}selected{% endif %}>Last Year</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Supplier</label>
                <select name="supplier_id" class="border border-gray-300 rounded px-3 py-2 w-48">
                    <option value="">All Suppliers</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}" {% if selected_supplier == supplier.id %}selected{% endif %}>
                        {{ supplier.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select name="category" class="border border-gray-300 rounded px-3 py-2 w-40">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Change Type</label>
                <select name="change_type" class="border border-gray-300 rounded px-3 py-2">
                    <option value="">All Changes</option>
                    <option value="increase" {% if change_type == 'increase' %}selected{% endif %}>Increases Only</option>
                    <option value="decrease" {% if change_type == 'decrease' %}selected{% endif %}>Decreases Only</option>
                </select>
            </div>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Filter</button>
            <a href="{{ url_for('inventory.price_history_list') }}" class="text-gray-600 hover:text-gray-800 px-3 py-2">Clear</a>
        </form>
    </div>

    <!-- Price Changes Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Old Price</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">New Price</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Change</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for change in price_changes %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ change.effective_date.strftime('%Y-%m-%d') if change.effective_date else change.recorded_at.strftime('%Y-%m-%d') }}
                    </td>
                    <td class="px-6 py-4">
                        <a href="{{ url_for('inventory.item_price_trends', item_id=change.consumable_id) }}" class="text-blue-600 hover:underline">
                            {{ change.item_name }}
                        </a>
                        {% if change.internal_sku %}
                        <p class="text-xs text-gray-500">{{ change.internal_sku }}</p>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="{{ url_for('inventory.supplier_detail', supplier_id=change.supplier_id) }}" class="text-gray-600 hover:text-blue-600">
                            {{ change.supplier_name }}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-gray-600">
                        ${{ "{:.2f}".format(change.old_price) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right font-medium">
                        ${{ "{:.2f}".format(change.new_price) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        {% set pct = change.change_percentage %}
                        {% if pct > 0 %}
                        <span class="text-red-600 font-medium">+{{ "{:.1f}".format(pct) }}%</span>
                        <span class="text-red-400 text-xs ml-1">(+${{ "{:.2f}".format(change.new_price - change.old_price) }})</span>
                        {% elif pct < 0 %}
                        <span class="text-green-600 font-medium">{{ "{:.1f}".format(pct) }}%</span>
                        <span class="text-green-400 text-xs ml-1">(-${{ "{:.2f}".format(change.old_price - change.new_price) }})</span>
                        {% else %}
                        <span class="text-gray-400">No change</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if change.source == 'api_sync' %}
                        <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">API Sync</span>
                        {% elif change.source == 'manual' %}
                        <span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded">Manual</span>
                        {% elif change.source == 'invoice' %}
                        <span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Invoice</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded">{{ change.source or 'Unknown' }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                        No price changes found for the selected filters.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Price Change Chart -->
    {% if price_changes %}
    <div class="bg-white rounded-lg shadow p-6 mt-6">
        <h2 class="text-lg font-semibold mb-4">Price Change Trends</h2>
        <div id="priceChangeChart" style="height: 300px;"></div>
    </div>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script>
        // Group price changes by date
        const changeData = {{ price_changes | tojson }};

        // Create daily aggregates
        const dailyData = {};
        changeData.forEach(change => {
            const date = change.effective_date || change.recorded_at.split('T')[0];
            if (!dailyData[date]) {
                dailyData[date] = { increases: 0, decreases: 0, totalPct: 0, count: 0 };
            }
            if (change.change_percentage > 0) {
                dailyData[date].increases++;
            } else if (change.change_percentage < 0) {
                dailyData[date].decreases++;
            }
            dailyData[date].totalPct += change.change_percentage;
            dailyData[date].count++;
        });

        const dates = Object.keys(dailyData).sort();
        const increases = dates.map(d => dailyData[d].increases);
        const decreases = dates.map(d => dailyData[d].decreases);
        const avgChange = dates.map(d => dailyData[d].count > 0 ? dailyData[d].totalPct / dailyData[d].count : 0);

        Plotly.newPlot('priceChangeChart', [
            {
                x: dates,
                y: increases,
                name: 'Price Increases',
                type: 'bar',
                marker: { color: '#EF4444' }
            },
            {
                x: dates,
                y: decreases.map(v => -v),
                name: 'Price Decreases',
                type: 'bar',
                marker: { color: '#10B981' }
            }
        ], {
            barmode: 'relative',
            legend: { orientation: 'h', y: 1.1 },
            margin: { t: 30, r: 20, l: 50, b: 50 },
            xaxis: { title: 'Date' },
            yaxis: { title: 'Number of Changes' }
        }, { responsive: true });
    </script>
    {% endif %}
</div>
{% endblock %}
