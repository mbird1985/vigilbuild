{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">{{ supplier.name }}</h1>
            <div class="flex items-center space-x-2 mt-1">
                {% if supplier.preferred %}
                <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm font-medium">Preferred</span>
                {% endif %}
                {% if supplier.active %}
                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">Active</span>
                {% else %}
                <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm">Inactive</span>
                {% endif %}
                {% if supplier.has_api %}
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">API Connected</span>
                {% endif %}
            </div>
        </div>
        <div class="flex space-x-2">
            <a href="{{ url_for('inventory.edit_supplier', supplier_id=supplier.id) }}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                Edit Supplier
            </a>
            <a href="{{ url_for('inventory.suppliers_page') }}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                Back to Suppliers
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Contact Info & Details -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Company Information -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">Company Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm text-gray-500">Primary Contact</label>
                        <p class="font-medium">{{ supplier.contact_person or 'Not set' }}</p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Email</label>
                        <p class="font-medium">
                            {% if supplier.email %}
                            <a href="mailto:{{ supplier.email }}" class="text-blue-600 hover:underline">{{ supplier.email }}</a>
                            {% else %}Not set{% endif %}
                        </p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Phone</label>
                        <p class="font-medium">
                            {% if supplier.phone %}
                            <a href="tel:{{ supplier.phone }}" class="text-blue-600 hover:underline">{{ supplier.phone }}</a>
                            {% else %}Not set{% endif %}
                        </p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Website</label>
                        <p class="font-medium">
                            {% if supplier.website %}
                            <a href="{{ supplier.website }}" target="_blank" class="text-blue-600 hover:underline">{{ supplier.website }}</a>
                            {% else %}Not set{% endif %}
                        </p>
                    </div>
                </div>

                <h3 class="text-md font-semibold mt-6 mb-3">Address</h3>
                <div class="bg-gray-50 p-4 rounded">
                    {% if supplier.address %}
                    <p>{{ supplier.address }}</p>
                    <p>{{ supplier.city }}{% if supplier.state %}, {{ supplier.state }}{% endif %} {{ supplier.zip_code }}</p>
                    <p>{{ supplier.country }}</p>
                    {% else %}
                    <p class="text-gray-500">No address on file</p>
                    {% endif %}
                </div>

                <h3 class="text-md font-semibold mt-6 mb-3">Business Terms</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 p-3 rounded">
                        <label class="text-sm text-gray-500">Account Number</label>
                        <p class="font-medium">{{ supplier.account_number or 'N/A' }}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <label class="text-sm text-gray-500">Payment Terms</label>
                        <p class="font-medium">{{ supplier.payment_terms or 'N/A' }}</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded">
                        <label class="text-sm text-gray-500">Shipping Terms</label>
                        <p class="font-medium">{{ supplier.shipping_terms or 'N/A' }}</p>
                    </div>
                </div>

                {% if supplier.notes %}
                <h3 class="text-md font-semibold mt-6 mb-3">Notes</h3>
                <div class="bg-yellow-50 p-4 rounded border border-yellow-200">
                    <p>{{ supplier.notes }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Contacts -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-semibold">Contacts</h2>
                    <button onclick="document.getElementById('addContactModal').classList.remove('hidden')"
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                        Add Contact
                    </button>
                </div>
                {% if supplier.contacts %}
                <div class="space-y-3">
                    {% for contact in supplier.contacts %}
                    <div class="flex justify-between items-start p-3 bg-gray-50 rounded">
                        <div>
                            <p class="font-medium">{{ contact.name }}</p>
                            <p class="text-sm text-gray-600">{{ contact.title or '' }} ({{ contact.contact_type }})</p>
                            <div class="text-sm text-gray-500 mt-1">
                                {% if contact.email %}<span class="mr-3">{{ contact.email }}</span>{% endif %}
                                {% if contact.phone %}<span>{{ contact.phone }}</span>{% endif %}
                            </div>
                        </div>
                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">{{ contact.preferred_contact_method }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-4">No additional contacts</p>
                {% endif %}
            </div>

            <!-- Items Supplied -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">Items from this Supplier</h2>
                {% if supplier.items %}
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Item</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Supplier SKU</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Unit Price</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Lead Time</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Preferred</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for item in supplier.items %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-2">
                                    <a href="{{ url_for('inventory.inventory_detail', item_id=item.consumable_id) }}" class="text-blue-600 hover:underline">
                                        {{ item.item_name }}
                                    </a>
                                </td>
                                <td class="px-4 py-2 text-gray-600">{{ item.supplier_sku or 'N/A' }}</td>
                                <td class="px-4 py-2 text-right">${{ "{:.2f}".format(item.cost_per_unit) if item.cost_per_unit else 'N/A' }}</td>
                                <td class="px-4 py-2 text-right">{{ item.lead_time_days or 'N/A' }} days</td>
                                <td class="px-4 py-2 text-center">
                                    {% if item.preferred %}
                                    <span class="text-green-600">Yes</span>
                                    {% else %}
                                    <span class="text-gray-400">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-4">No items linked to this supplier</p>
                {% endif %}
            </div>
        </div>

        <!-- Right Column: Metrics & API -->
        <div class="space-y-6">
            <!-- Performance Metrics -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">Performance Metrics</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Total Orders</span>
                        <span class="font-bold text-lg">{{ supplier.metrics.total_orders }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Completed</span>
                        <span class="font-bold text-lg text-green-600">{{ supplier.metrics.completed_orders }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Total Spend</span>
                        <span class="font-bold text-lg">${{ "{:,.2f}".format(supplier.metrics.total_spend) }}</span>
                    </div>
                    <hr>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Avg Lead Time</span>
                        <span class="font-medium">{{ supplier.metrics.avg_lead_time or 'N/A' }} days</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Avg Delay</span>
                        <span class="font-medium {% if supplier.metrics.avg_delay > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                            {{ supplier.metrics.avg_delay or 0 }} days
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">On-Time Rate</span>
                        <span class="font-bold text-lg {% if supplier.metrics.on_time_rate >= 90 %}text-green-600{% elif supplier.metrics.on_time_rate >= 75 %}text-yellow-600{% else %}text-red-600{% endif %}">
                            {{ supplier.metrics.on_time_rate }}%
                        </span>
                    </div>
                </div>
            </div>

            <!-- API Integration -->
            {% if supplier.has_api %}
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">API Integration</h2>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm text-gray-500">Endpoint</label>
                        <p class="text-sm font-mono bg-gray-50 p-2 rounded break-all">{{ supplier.api_endpoint }}</p>
                    </div>
                    <div>
                        <label class="text-sm text-gray-500">Auth Type</label>
                        <p class="font-medium">{{ supplier.api_auth_type or 'Not specified' }}</p>
                    </div>
                    <div class="flex space-x-2 pt-2">
                        <button onclick="testApiConnection({{ supplier.id }})"
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm">
                            Test Connection
                        </button>
                        <button onclick="syncCatalog({{ supplier.id }})"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">
                            Sync Catalog
                        </button>
                    </div>
                    <div id="apiStatus" class="hidden p-3 rounded text-sm"></div>
                </div>

                {% if sync_history %}
                <h3 class="text-md font-semibold mt-4 mb-2">Sync History</h3>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                    {% for sync in sync_history[:5] %}
                    <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded">
                        <span>{{ sync.sync_type }}</span>
                        <span class="{% if sync.status == 'completed' %}text-green-600{% elif sync.status == 'failed' %}text-red-600{% else %}text-yellow-600{% endif %}">
                            {{ sync.status }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">API Integration</h2>
                <p class="text-gray-500 text-center py-4">No API configured</p>
                <a href="{{ url_for('inventory.edit_supplier', supplier_id=supplier.id) }}"
                   class="block text-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    Configure API
                </a>
            </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">Quick Actions</h2>
                <div class="space-y-2">
                    <a href="{{ url_for('inventory.create_purchase_order') }}?supplier={{ supplier.id }}"
                       class="block bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-center">
                        Create Purchase Order
                    </a>
                    <a href="{{ url_for('inventory.price_history_list') }}?supplier_id={{ supplier.id }}"
                       class="block bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-center">
                        View Price History
                    </a>
                    <a href="{{ url_for('inventory.purchase_orders_list') }}?supplier_id={{ supplier.id }}"
                       class="block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-center">
                        View Orders
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Price History Section -->
    {% if price_history %}
    <div class="bg-white rounded-lg shadow p-6 mt-6">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h2 class="text-lg font-semibold">Recent Price Changes</h2>
            <a href="{{ url_for('inventory.price_history_list') }}?supplier_id={{ supplier.id }}" class="text-blue-600 hover:underline text-sm">
                View All
            </a>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Item</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Old Price</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">New Price</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Change</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for change in price_history[:10] %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2">{{ change.item_name }}</td>
                        <td class="px-4 py-2 text-right">${{ "{:.2f}".format(change.old_price) if change.old_price else 'N/A' }}</td>
                        <td class="px-4 py-2 text-right font-medium">${{ "{:.2f}".format(change.new_price) }}</td>
                        <td class="px-4 py-2 text-right {% if change.change_percentage > 0 %}text-red-600{% elif change.change_percentage < 0 %}text-green-600{% endif %}">
                            {{ "{:+.1f}".format(change.change_percentage) }}%
                        </td>
                        <td class="px-4 py-2 text-gray-500">{{ change.change_date.strftime('%Y-%m-%d') if change.change_date else '' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Contact Modal -->
<div id="addContactModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4">Add Contact</h3>
        <form action="{{ url_for('inventory.add_supplier_contact', supplier_id=supplier.id) }}" method="POST">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Name *</label>
                    <input type="text" name="name" required class="mt-1 block w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" name="title" class="mt-1 block w-full border border-gray-300 rounded px-3 py-2">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" name="email" class="mt-1 block w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Phone</label>
                        <input type="text" name="phone" class="mt-1 block w-full border border-gray-300 rounded px-3 py-2">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Contact Type</label>
                        <select name="contact_type" class="mt-1 block w-full border border-gray-300 rounded px-3 py-2">
                            <option value="primary">Primary</option>
                            <option value="billing">Billing</option>
                            <option value="sales">Sales</option>
                            <option value="support">Support</option>
                            <option value="emergency">Emergency</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Preferred Method</label>
                        <select name="preferred_contact_method" class="mt-1 block w-full border border-gray-300 rounded px-3 py-2">
                            <option value="email">Email</option>
                            <option value="phone">Phone</option>
                            <option value="portal">Portal</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button type="button" onclick="document.getElementById('addContactModal').classList.add('hidden')"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">Cancel</button>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Add Contact</button>
            </div>
        </form>
    </div>
</div>

<script>
function testApiConnection(supplierId) {
    const statusDiv = document.getElementById('apiStatus');
    statusDiv.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'text-green-700', 'text-red-700');
    statusDiv.classList.add('bg-yellow-100', 'text-yellow-700');
    statusDiv.textContent = 'Testing connection...';

    fetch(`/inventory/suppliers/${supplierId}/api/test`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            statusDiv.classList.remove('bg-yellow-100', 'text-yellow-700');
            if (data.success) {
                statusDiv.classList.add('bg-green-100', 'text-green-700');
                statusDiv.textContent = 'Connection successful!';
            } else {
                statusDiv.classList.add('bg-red-100', 'text-red-700');
                statusDiv.textContent = 'Connection failed: ' + (data.error || 'Unknown error');
            }
        })
        .catch(err => {
            statusDiv.classList.remove('bg-yellow-100', 'text-yellow-700');
            statusDiv.classList.add('bg-red-100', 'text-red-700');
            statusDiv.textContent = 'Error: ' + err.message;
        });
}

function syncCatalog(supplierId) {
    const statusDiv = document.getElementById('apiStatus');
    statusDiv.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'text-green-700', 'text-red-700');
    statusDiv.classList.add('bg-yellow-100', 'text-yellow-700');
    statusDiv.textContent = 'Syncing catalog...';

    fetch(`/inventory/suppliers/${supplierId}/api/sync`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            statusDiv.classList.remove('bg-yellow-100', 'text-yellow-700');
            if (data.success) {
                statusDiv.classList.add('bg-green-100', 'text-green-700');
                statusDiv.textContent = data.message || 'Sync completed!';
            } else {
                statusDiv.classList.add('bg-red-100', 'text-red-700');
                statusDiv.textContent = 'Sync failed: ' + (data.error || 'Unknown error');
            }
        })
        .catch(err => {
            statusDiv.classList.remove('bg-yellow-100', 'text-yellow-700');
            statusDiv.classList.add('bg-red-100', 'text-red-700');
            statusDiv.textContent = 'Error: ' + err.message;
        });
}
</script>
{% endblock %}
